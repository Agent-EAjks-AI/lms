name: LMS CLI Tests

# Group workflow runs by branch and cancel in-progress runs on new commits to avoid PR wastefulness
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  build-and-test:
    name: Build and Test LMS CLI
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Determine lmstudio.js branch
        id: branch
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "$PR_BODY" > pr_body.txt
          LMS_JS_BRANCH=$(grep -oP 'lmstudio-js-branch:\s*\K\S+' pr_body.txt || true)

          # Fallback to main if not found
          if [ -z "$LMS_JS_BRANCH" ]; then
            LMS_JS_BRANCH="main"
          fi

          echo "branch=$LMS_JS_BRANCH" >> $GITHUB_OUTPUT

          if [ -z "$LMS_JS_BRANCH" ]; then
            LMS_JS_BRANCH="main"
          fi

          echo "branch=$LMS_JS_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout lmstudio.js repo
        uses: actions/checkout@v4
        with:
          repository: lmstudio-ai/lmstudio-js
          ref: ${{ steps.branch.outputs.branch }}
          path: lmstudio.js
          submodules: true
      - name: Fetch and checkout lms-cli branch
        run: |
          cd lmstudio.js/packages/lms-cli
          git fetch origin ${{ github.head_ref }}:${{ github.head_ref }}
          git checkout ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: lmstudio.js/package-lock.json

      - name: Install dependencies
        run: |
          cd lmstudio.js
          npm install

      - name: Build lmstudio.js
        run: |
          cd lmstudio.js
          npm run build

      - name: Run the llmster docker image
        id: run
        uses: ./lmstudio.js/packages/lms-cli/.github/actions/docker-daemon-run
        with:
          docker-image: lmstudio/llmster-preview
          container-name: llmster-test

      - name: Ensure the model needed for testing is available
        run: |
          docker exec ${{ steps.run.outputs.container-name }} lms get gemma-3-1b --yes

      - name: Run lms-cli tests
        run: |
          cd lmstudio.js
          npm run test-cli

      - name: Cleanup container
        if: always()
        run: |
          docker stop ${{ steps.run.outputs.container-name }} || true
          docker rm ${{ steps.run.outputs.container-name }} || true
          docker rmi ${{ steps.build.outputs.docker-image }} || true
